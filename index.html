<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ثبت اطلاعات فروشگاه ها</title>

    <!-- Fonts: Vazirmatn -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <!-- Bootstrap 5 RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" integrity="sha384-nU14brUcp6StFntEOOEBvcJm4huWjB0OcIeQ3fltAfSmuZFrkAif0T+UtNGlKKQv" crossorigin="anonymous">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f8f9fa;
            padding-bottom: 80px; /* Space for FAB */
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card.visited {
            background-color: #d1e7dd;
            border: 1px solid #badbcc;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .fab-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }

        .fab-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #0d6efd;
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(13, 110, 253, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }

        .fab-button:hover {
            background-color: #0b5ed7;
            transform: scale(1.05);
        }

        .order-history {
            font-size: 0.85rem;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            margin-top: 10px;
            padding-top: 10px;
        }

        .badge-region {
            background-color: #6c757d;
        }

        .navbar-brand {
            font-weight: 700;
        }

        /* Checkbox styling within dropdown/list */
        .day-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top mb-3">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-briefcase-fill me-2"></i>
                ثبت اطلاعات فروشگاه ها
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="app.resetDailyVisits()">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>
                            شروع روز جدید
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#settingsModal">
                            <i class="bi bi-gear-fill me-1"></i>
                            تنظیمات
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="app.showDailySales()">
                            <i class="bi bi-clipboard-data-fill me-1"></i>
                            آمار فروش روزانه
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="app.switchView('orders')">
                            <i class="bi bi-receipt me-1"></i>
                            مدیریت سفارش‌ها
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">

        <!-- View: Dashboard -->
        <div id="dashboardView">
            <!-- Filters & Search -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label">جستجو</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="نام فروشگاه یا آدرس..." oninput="app.renderStores()">
                </div>
                <div class="col-md-3">
                    <label class="form-label">فیلتر زمان</label>
                    <select class="form-select" id="filterDay" onchange="app.renderStores()">
                        <option value="today" selected>برنامه امروز (هوشمند)</option>
                        <option value="all">همه روزها</option>
                        <option value="6">شنبه</option>
                        <option value="0">یکشنبه</option>
                        <option value="1">دوشنبه</option>
                        <option value="2">سه‌شنبه</option>
                        <option value="3">چهارشنبه</option>
                        <option value="4">پنج‌شنبه</option>
                        <option value="5">جمعه</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">فیلتر منطقه</label>
                    <select class="form-select" id="filterRegion" onchange="app.renderStores()">
                        <option value="all">همه مناطق</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">احتمال خرید</label>
                    <select class="form-select" id="filterProb" onchange="app.renderStores()">
                        <option value="all">همه</option>
                        <option value="high">زیاد</option>
                        <option value="low">کم</option>
                    </select>
                </div>
            </div>

            <!-- Stores Grid -->
            <div class="row g-3" id="storesContainer">
                <!-- Content populated by JS -->
            </div>

            <!-- Empty State (Hidden by default) -->
            <div id="emptyState" class="text-center py-5 d-none">
                <i class="bi bi-shop display-1 text-muted"></i>
                <p class="mt-3 text-muted">موردی یافت نشد یا لیستی وجود ندارد.</p>
            </div>
        </div>

        <!-- View: Orders Management -->
        <div id="ordersView" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold"><i class="bi bi-receipt me-2"></i>مدیریت سفارش‌ها</h4>
                <button class="btn btn-outline-secondary" onclick="app.switchView('dashboard')">
                    <i class="bi bi-arrow-right me-1"></i> بازگشت
                </button>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label small text-muted">فیلتر تاریخ</label>
                    <input type="date" class="form-control" id="orderDateFilter" onchange="app.renderAllOrders()">
                </div>
            </div>

            <div class="table-responsive bg-white rounded shadow-sm p-3">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>تاریخ</th>
                            <th>فروشگاه</th>
                            <th>آدرس</th>
                            <th>اقلام سفارش</th>
                            <th>توضیحات</th>
                            <th class="text-end">عملیات</th>
                        </tr>
                    </thead>
                    <tbody id="allOrdersList">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
                <div id="noOrdersMsg" class="text-center text-muted py-4 d-none">هیچ سفارشی ثبت نشده است.</div>
            </div>
        </div>

    </div>

    <!-- FAB: Add Store (Only on Dashboard) -->
    <div class="fab-container" id="fabContainer">
        <button class="fab-button" onclick="app.openAddStoreModal()" title="افزودن فروشگاه">
            <i class="bi bi-plus-lg"></i>
        </button>
    </div>

    <!-- Modal: Daily Sales -->
    <div class="modal fade" id="dailySalesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">آمار فروش امروز</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="dailySalesContent">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Settings (Regions & Backup) -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تنظیمات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 class="fw-bold">مدیریت مناطق</h6>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="newRegionInput" placeholder="نام منطقه جدید...">
                        <button class="btn btn-success" type="button" onclick="app.addRegion()">افزودن</button>
                    </div>
                    <ul class="list-group mb-4" id="regionList">
                        <!-- Populated by JS -->
                    </ul>

                    <hr>

                    <h6 class="fw-bold">مدیریت کالاها</h6>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="newProductInput" placeholder="نام کالا جدید...">
                        <button class="btn btn-success" type="button" onclick="app.addProduct()">افزودن</button>
                    </div>
                    <ul class="list-group mb-4" id="productList">
                        <!-- Populated by JS -->
                    </ul>

                    <hr>

                    <h6 class="fw-bold mb-3">پشتیبان‌گیری و بازیابی</h6>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary w-50" onclick="app.backupData()">
                            <i class="bi bi-download"></i> دانلود بکاپ
                        </button>
                        <button class="btn btn-outline-warning w-50" onclick="document.getElementById('backupInput').click()">
                            <i class="bi bi-upload"></i> بازیابی بکاپ
                        </button>
                        <input type="file" id="backupInput" accept=".json" class="d-none" onchange="app.restoreData(this)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Add/Edit Store -->
    <div class="modal fade" id="addStoreModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="storeModalTitle">ثبت فروشگاه جدید</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStoreForm">
                        <input type="hidden" id="storeId">
                        <div class="mb-3">
                            <label class="form-label">نام فروشگاه</label>
                            <input type="text" class="form-control" id="storeName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">توضیحات</label>
                            <textarea class="form-control" id="storeDescription" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">نام فروشنده</label>
                            <input type="text" class="form-control" id="storeSellerName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">آدرس</label>
                            <textarea class="form-control" id="storeAddress" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">شماره همراه</label>
                            <input type="tel" class="form-control" id="storePhone" placeholder="09xxxxxxxxx">
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">منطقه</label>
                                <select class="form-select" id="storeRegion" required>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">زمان ایده‌آل</label>
                                <select class="form-select" id="storeIdealTime">
                                    <option value="">انتخاب کنید...</option>
                                    <option value="morning">صبح</option>
                                    <option value="noon">ظهر</option>
                                    <option value="night">شب</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">احتمال خرید</label>
                            <select class="form-select" id="storePurchaseProb">
                                <option value="">نامشخص</option>
                                <option value="high">زیاد</option>
                                <option value="low">کم</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">روزهای ویزیت</label>
                            <div class="day-checkbox-group border rounded p-2 bg-light">
                                <div class="form-check me-3">
                                    <input class="form-check-input store-day-check" type="checkbox" value="6" id="d6">
                                    <label class="form-check-label" for="d6">شنبه</label>
                                </div>
                                <div class="form-check me-3">
                                    <input class="form-check-input store-day-check" type="checkbox" value="0" id="d0">
                                    <label class="form-check-label" for="d0">یکشنبه</label>
                                </div>
                                <div class="form-check me-3">
                                    <input class="form-check-input store-day-check" type="checkbox" value="1" id="d1">
                                    <label class="form-check-label" for="d1">دوشنبه</label>
                                </div>
                                <div class="form-check me-3">
                                    <input class="form-check-input store-day-check" type="checkbox" value="2" id="d2">
                                    <label class="form-check-label" for="d2">سه‌شنبه</label>
                                </div>
                                <div class="form-check me-3">
                                    <input class="form-check-input store-day-check" type="checkbox" value="3" id="d3">
                                    <label class="form-check-label" for="d3">چهارشنبه</label>
                                </div>
                                <div class="form-check me-3">
                                    <input class="form-check-input store-day-check" type="checkbox" value="4" id="d4">
                                    <label class="form-check-label" for="d4">پنج‌شنبه</label>
                                </div>
                                <div class="form-check me-3">
                                    <input class="form-check-input store-day-check" type="checkbox" value="5" id="d5">
                                    <label class="form-check-label" for="d5">جمعه</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
                    <button type="button" class="btn btn-primary" onclick="app.saveStore()">ذخیره</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Add/Edit Order -->
    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderModalTitle">ثبت سفارش</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="orderStoreId">
                    <input type="hidden" id="orderId">
                    <div class="mb-3">
                        <label class="form-label">توضیحات (اختیاری)</label>
                        <textarea class="form-control" id="orderText" rows="2"></textarea>
                    </div>

                    <hr>
                    <h6 class="fw-bold">اقلام سفارش</h6>

                    <div class="row g-2 align-items-end mb-3">
                        <div class="col-6">
                            <label class="form-label small">نام کالا</label>
                            <select class="form-select form-select-sm" id="orderProductSelect">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div class="col-4">
                            <label class="form-label small">تعداد کارتن</label>
                            <div class="input-group input-group-sm">
                                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('orderCartonCount').stepDown()">-</button>
                                <input type="number" class="form-control text-center" id="orderCartonCount" value="1" min="1">
                                <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('orderCartonCount').stepUp()">+</button>
                            </div>
                        </div>
                        <div class="col-2">
                            <button class="btn btn-success btn-sm w-100" type="button" onclick="app.addOrderItem()">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive mb-3 bg-light rounded p-2" style="max-height: 150px; overflow-y: auto;">
                        <table class="table table-sm table-borderless mb-0">
                            <tbody id="orderItemsList">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                        <div id="noItemsMsg" class="text-center text-muted small">لیست خالی است</div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
                    <button type="button" class="btn btn-success" onclick="app.saveOrder()">ثبت نهایی</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <script>
        /**
         * Main Application Logic
         */
        const app = {
            data: {
                regions: [],
                stores: [],
                products: []
            },

            currentView: 'dashboard',
            currentOrderItems: [], // Temporary state for order modal

            // Map JS Date.getDay() to Persian names
            // JS: 0=Sun, 1=Mon, ..., 6=Sat
            daysMap: {
                6: 'شنبه',
                0: 'یکشنبه',
                1: 'دوشنبه',
                2: 'سه‌شنبه',
                3: 'چهارشنبه',
                4: 'پنج‌شنبه',
                5: 'جمعه'
            },

            idealTimeMap: {
                'morning': 'صبح',
                'noon': 'ظهر',
                'night': 'شب'
            },

            init: function() {
                this.loadData();
                this.renderRegions(); // In modal and filters
                this.renderStores();
                this.switchView('dashboard'); // Default view
            },

            switchView: function(viewName) {
                this.currentView = viewName;
                const dashboard = document.getElementById('dashboardView');
                const orders = document.getElementById('ordersView');
                const fab = document.getElementById('fabContainer');

                if (viewName === 'dashboard') {
                    dashboard.classList.remove('d-none');
                    orders.classList.add('d-none');
                    fab.classList.remove('d-none');
                    this.renderStores(); // Re-render to ensure updates
                } else if (viewName === 'orders') {
                    dashboard.classList.add('d-none');
                    orders.classList.remove('d-none');
                    fab.classList.add('d-none');
                    this.renderAllOrders();
                }
            },

            openAddStoreModal: function() {
                this.populateRegionDropdown('storeRegion'); // Ensure dropdown is populated
                document.getElementById('addStoreForm').reset();
                document.getElementById('storeId').value = '';
                document.getElementById('storeDescription').value = '';
                document.getElementById('storeSellerName').value = '';
                document.getElementById('storePhone').value = '';
                document.getElementById('storePurchaseProb').value = '';
                document.getElementById('storeModalTitle').textContent = 'ثبت فروشگاه جدید';

                // Reset checkboxes
                document.querySelectorAll('.store-day-check').forEach(cb => cb.checked = false);

                const modal = new bootstrap.Modal(document.getElementById('addStoreModal'));
                modal.show();
            },

            loadData: function() {
                const storedRegions = localStorage.getItem('visitor_regions');
                const storedStores = localStorage.getItem('visitor_stores');
                const storedProducts = localStorage.getItem('visitor_products');

                if (storedRegions) {
                    this.data.regions = JSON.parse(storedRegions);
                } else {
                    // Default regions
                    this.data.regions = ['شمال شهر', 'مرکز بازار', 'حاشیه شهر'];
                    this.saveData();
                }

                if (storedStores) {
                    this.data.stores = JSON.parse(storedStores);
                    // Ensure all orders have IDs (Backfill for legacy data)
                    this.data.stores.forEach(store => {
                        if (store.orders) {
                            store.orders.forEach((order, index) => {
                                if (!order.id) {
                                    order.id = Date.now() + Math.random(); // Simple unique ID
                                }
                            });
                        }
                    });
                }

                if (storedProducts) {
                    this.data.products = JSON.parse(storedProducts);
                }
            },

            saveData: function() {
                localStorage.setItem('visitor_regions', JSON.stringify(this.data.regions));
                localStorage.setItem('visitor_stores', JSON.stringify(this.data.stores));
                localStorage.setItem('visitor_products', JSON.stringify(this.data.products));
                // Re-render UI elements that depend on data
                this.renderStores();
            },

            // --- Backup & Restore Logic ---

            backupData: function() {
                const data = {
                    regions: this.data.regions,
                    stores: this.data.stores,
                    products: this.data.products
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `visitor_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            restoreData: function(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.regions && data.stores) {
                            if(confirm('آیا مطمئن هستید؟ تمام داده‌های فعلی با فایل جایگزین خواهند شد.')) {
                                this.data.regions = data.regions;
                                this.data.stores = data.stores;
                                this.data.products = data.products || []; // Optional backward compatibility
                                this.saveData();
                                this.renderRegions();
                                // We also need to render products if the settings modal is open, but simple enough to just init
                                alert('بازیابی با موفقیت انجام شد.');
                            }
                        } else {
                            alert('فایل انتخاب شده معتبر نیست.');
                        }
                    } catch (error) {
                        console.error(error);
                        alert('خطا در خواندن فایل.');
                    }
                    input.value = ''; // Reset input
                };
                reader.readAsText(file);
            },

            // --- Region Logic ---

            addRegion: function() {
                const input = document.getElementById('newRegionInput');
                const name = input.value.trim();
                if (name && !this.data.regions.includes(name)) {
                    this.data.regions.push(name);
                    input.value = '';
                    this.saveData();
                    this.renderRegions();
                } else if (this.data.regions.includes(name)) {
                    alert('این منطقه قبلاً ثبت شده است.');
                }
            },

            removeRegion: function(index) {
                if (confirm('آیا از حذف این منطقه مطمئن هستید؟')) {
                    this.data.regions.splice(index, 1);
                    this.saveData();
                    this.renderRegions();
                }
            },

            renderRegions: function() {
                // Update Modal List
                const list = document.getElementById('regionList');
                list.innerHTML = '';
                this.data.regions.forEach((region, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        ${this.escapeHtml(region)}
                        <button class="btn btn-sm btn-outline-danger" onclick="app.removeRegion(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                    list.appendChild(li);
                });

                // Update Filter Dropdown
                this.populateRegionDropdown('filterRegion', true);

                // Render Products as well (since we are here)
                this.renderProducts();
            },

            // --- Product Logic ---

            addProduct: function() {
                const input = document.getElementById('newProductInput');
                if (!input) {
                    console.error("New product input not found");
                    return;
                }
                const name = input.value.trim();
                if (name) {
                    // Check duplicate
                    if (this.data.products.some(p => p.name === name)) {
                        alert('این کالا قبلاً ثبت شده است.');
                        return;
                    }
                    this.data.products.push({ id: Date.now(), name });
                    input.value = '';
                    this.saveData();

                    // Explicitly render immediately and log
                    this.renderProducts();
                    console.log("Product added:", name);
                } else {
                    console.warn("Product name is empty");
                }
            },

            removeProduct: function(id) {
                if (confirm('آیا از حذف این کالا مطمئن هستید؟')) {
                    this.data.products = this.data.products.filter(p => p.id !== id);
                    this.saveData();
                    this.renderProducts();
                }
            },

            renderProducts: function() {
                const list = document.getElementById('productList');
                if (!list) return;
                list.innerHTML = '';
                this.data.products.forEach(product => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        ${this.escapeHtml(product.name)}
                        <button class="btn btn-sm btn-outline-danger" onclick="app.removeProduct(${product.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                    list.appendChild(li);
                });
            },

            populateRegionDropdown: function(elementId, isFilter = false) {
                const select = document.getElementById(elementId);
                const currentVal = select.value;
                select.innerHTML = isFilter ? '<option value="all">همه مناطق</option>' : '';

                this.data.regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region;
                    option.textContent = region; // textContent handles escaping automatically
                    select.appendChild(option);
                });

                if (isFilter && currentVal) {
                    select.value = currentVal; // Maintain selection if possible
                }
            },

            // --- Store Logic ---

            saveStore: function() {
                const id = document.getElementById('storeId').value;
                const name = document.getElementById('storeName').value.trim();
                const description = document.getElementById('storeDescription').value.trim();
                const sellerName = document.getElementById('storeSellerName').value.trim();
                const address = document.getElementById('storeAddress').value.trim();
                const phone = document.getElementById('storePhone').value.trim();
                const region = document.getElementById('storeRegion').value;
                const idealTime = document.getElementById('storeIdealTime').value;
                const purchaseProb = document.getElementById('storePurchaseProb').value;

                // Get checked days
                const checkedDays = [];
                document.querySelectorAll('.store-day-check:checked').forEach(cb => {
                    checkedDays.push(parseInt(cb.value));
                });

                if (!name || !region) {
                    alert('لطفاً نام فروشگاه و منطقه را وارد کنید.');
                    return;
                }

                if (id) {
                    // Update existing
                    const storeIndex = this.data.stores.findIndex(s => s.id == id);
                    if (storeIndex > -1) {
                        this.data.stores[storeIndex].name = name;
                        this.data.stores[storeIndex].description = description;
                        this.data.stores[storeIndex].sellerName = sellerName;
                        this.data.stores[storeIndex].address = address;
                        this.data.stores[storeIndex].phone = phone;
                        this.data.stores[storeIndex].region = region;
                        this.data.stores[storeIndex].idealTime = idealTime;
                        this.data.stores[storeIndex].purchaseProb = purchaseProb;
                        this.data.stores[storeIndex].visitDays = checkedDays;
                    }
                } else {
                    // Create new
                    const newStore = {
                        id: Date.now(),
                        name,
                        description,
                        sellerName,
                        address,
                        phone,
                        region,
                        idealTime,
                        purchaseProb,
                        visitDays: checkedDays,
                        visited: false,
                        orders: []
                    };
                    this.data.stores.push(newStore);
                }

                this.saveData();

                // Close modal
                const modalEl = document.getElementById('addStoreModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
            },

            editStore: function(storeId) {
                const store = this.data.stores.find(s => s.id === storeId);
                if (!store) return;

                // Populate dropdown first so we can set the value
                this.populateRegionDropdown('storeRegion');

                document.getElementById('storeId').value = store.id;
                document.getElementById('storeName').value = store.name;
                document.getElementById('storeDescription').value = store.description || '';
                document.getElementById('storeSellerName').value = store.sellerName || '';
                document.getElementById('storeAddress').value = store.address || '';
                document.getElementById('storePhone').value = store.phone || '';
                document.getElementById('storeRegion').value = store.region;
                document.getElementById('storeIdealTime').value = store.idealTime || '';
                document.getElementById('storePurchaseProb').value = store.purchaseProb || '';
                document.getElementById('storeModalTitle').textContent = 'ویرایش فروشگاه';

                // Reset and Set checkboxes
                document.querySelectorAll('.store-day-check').forEach(cb => {
                    cb.checked = store.visitDays.includes(parseInt(cb.value));
                });

                const modal = new bootstrap.Modal(document.getElementById('addStoreModal'));
                modal.show();
            },

            toggleVisit: function(storeId) {
                const store = this.data.stores.find(s => s.id === storeId);
                if (store) {
                    store.visited = !store.visited;
                    this.saveData();
                }
            },

            resetDailyVisits: function() {
                if(confirm('آیا مطمئن هستید که می‌خواهید شروع روز جدید را ثبت کنید؟ وضعیت ویزیت همه فروشگاه‌ها ریست می‌شود.')) {
                    this.data.stores.forEach(s => s.visited = false);
                    this.saveData();
                    alert('روز جدید شروع شد. همه ویزیت‌ها ریست شدند.');
                }
            },

            // --- Order Logic ---

            openOrderModal: function(storeId) {
                document.getElementById('orderStoreId').value = storeId;
                document.getElementById('orderId').value = ''; // Clear ID for new order
                document.getElementById('orderModalTitle').textContent = 'ثبت سفارش';
                document.getElementById('orderText').value = '';

                // Init Items
                this.currentOrderItems = [];
                this.renderOrderItems();

                // Populate Products Dropdown
                const select = document.getElementById('orderProductSelect');
                select.innerHTML = '<option value="">انتخاب کالا...</option>';
                this.data.products.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    select.appendChild(option);
                });

                // Reset Counter
                document.getElementById('orderCartonCount').value = 1;

                const modal = new bootstrap.Modal(document.getElementById('orderModal'));
                modal.show();
            },

            editOrder: function(storeId, orderId) {
                const store = this.data.stores.find(s => s.id === storeId);
                if (!store) return;
                const order = store.orders.find(o => o.id == orderId);
                if (!order) return;

                document.getElementById('orderStoreId').value = storeId;
                document.getElementById('orderId').value = orderId;
                document.getElementById('orderModalTitle').textContent = 'ویرایش سفارش';
                document.getElementById('orderText').value = order.text || '';

                // Load Items (Deep copy to avoid mutation reference issues before save)
                this.currentOrderItems = JSON.parse(JSON.stringify(order.items || []));
                this.renderOrderItems();

                // Populate Products Dropdown
                const select = document.getElementById('orderProductSelect');
                select.innerHTML = '<option value="">انتخاب کالا...</option>';
                this.data.products.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    select.appendChild(option);
                });

                document.getElementById('orderCartonCount').value = 1;

                const modal = new bootstrap.Modal(document.getElementById('orderModal'));
                modal.show();
            },

            addOrderItem: function() {
                const select = document.getElementById('orderProductSelect');
                const productId = parseInt(select.value);
                const productName = select.options[select.selectedIndex]?.text;
                const count = parseInt(document.getElementById('orderCartonCount').value);

                if (!productId || count < 1) {
                    alert('لطفاً کالا و تعداد را انتخاب کنید.');
                    return;
                }

                // Check existing
                const existing = this.currentOrderItems.find(i => i.productId === productId);
                if (existing) {
                    existing.count += count;
                } else {
                    this.currentOrderItems.push({ productId, productName, count });
                }

                this.renderOrderItems();
            },

            removeOrderItem: function(productId) {
                this.currentOrderItems = this.currentOrderItems.filter(i => i.productId !== productId);
                this.renderOrderItems();
            },

            renderOrderItems: function() {
                const list = document.getElementById('orderItemsList');
                const msg = document.getElementById('noItemsMsg');
                list.innerHTML = '';

                if (this.currentOrderItems.length === 0) {
                    msg.classList.remove('d-none');
                } else {
                    msg.classList.add('d-none');
                    this.currentOrderItems.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${this.escapeHtml(item.productName)}</td>
                            <td>${item.count} کارتن</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-danger p-0 px-1" onclick="app.removeOrderItem(${item.productId})">&times;</button>
                            </td>
                        `;
                        list.appendChild(tr);
                    });
                }
            },

            saveOrder: function() {
                const storeId = parseInt(document.getElementById('orderStoreId').value);
                const orderId = document.getElementById('orderId').value;
                const text = document.getElementById('orderText').value.trim();
                const items = this.currentOrderItems;

                if (items.length === 0 && !text) {
                     alert('لطفاً حداقل یک کالا یا توضیحات وارد کنید.');
                     return;
                }

                const store = this.data.stores.find(s => s.id === storeId);
                if (store) {
                    if (orderId) {
                        // Update existing order
                        const order = store.orders.find(o => o.id == orderId);
                        if (order) {
                            order.text = text;
                            order.items = items;
                            // Update date? usually not on edit, keep original date.
                        }
                    } else {
                        // Create new order
                        const order = {
                            id: Date.now() + Math.random(),
                            date: new Date().toLocaleDateString('fa-IR'),
                            text,
                            items: items
                        };
                        store.orders.unshift(order); // Add to beginning
                    }

                    this.saveData();

                    // Update UI based on current view
                    if (this.currentView === 'orders') {
                        this.renderAllOrders();
                    }

                    // Close modal
                    const modalEl = document.getElementById('orderModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                }
            },

            deleteOrder: function(storeId, orderId) {
                if (confirm('آیا از حذف این سفارش مطمئن هستید؟')) {
                    const store = this.data.stores.find(s => s.id === storeId);
                    if (store) {
                        store.orders = store.orders.filter(o => o.id != orderId);
                        this.saveData();

                        if (this.currentView === 'orders') {
                            this.renderAllOrders();
                        } else {
                            this.renderStores(); // Update dashboard
                        }
                    }
                }
            },

            renderAllOrders: function() {
                const list = document.getElementById('allOrdersList');
                const noOrdersMsg = document.getElementById('noOrdersMsg');
                const dateFilterInput = document.getElementById('orderDateFilter');

                if (!list) return;

                // Flatten orders
                let allOrders = [];
                this.data.stores.forEach(store => {
                    store.orders.forEach(order => {
                        allOrders.push({
                            ...order,
                            storeName: store.name,
                            storeAddress: store.address,
                            storeId: store.id
                        });
                    });
                });

                // Filter
                if (dateFilterInput.value) {
                    const [y, m, d] = dateFilterInput.value.split('-');
                    const dateObj = new Date(y, m - 1, d);
                    const persianDate = dateObj.toLocaleDateString('fa-IR');

                    allOrders = allOrders.filter(order => order.date === persianDate);
                }

                // Sort by ID desc
                allOrders.sort((a, b) => b.id - a.id);

                list.innerHTML = '';
                if (allOrders.length === 0) {
                    noOrdersMsg.classList.remove('d-none');
                } else {
                    noOrdersMsg.classList.add('d-none');
                    allOrders.forEach(order => {
                        let itemsText = '-';
                        if (order.items && order.items.length > 0) {
                            itemsText = order.items.map(i => `${i.count} ${this.escapeHtml(i.productName)}`).join('، ');
                        }

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${this.escapeHtml(order.date)}</td>
                            <td>${this.escapeHtml(order.storeName)}</td>
                            <td><small class="text-muted">${this.escapeHtml(order.storeAddress || '-')}</small></td>
                            <td><small>${itemsText}</small></td>
                            <td><small class="text-muted">${this.escapeHtml(order.text)}</small></td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="app.editOrder(${order.storeId}, ${order.id})" title="ویرایش">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="app.deleteOrder(${order.storeId}, ${order.id})" title="حذف">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        list.appendChild(tr);
                    });
                }
            },

            // --- Daily Sales Logic ---

            showDailySales: function() {
                const today = new Date().toLocaleDateString('fa-IR');
                let totalOrders = 0;
                let productCounts = {};

                this.data.stores.forEach(store => {
                    store.orders.forEach(order => {
                        if (order.date === today) {
                            totalOrders++;
                            if (order.items) {
                                order.items.forEach(item => {
                                    if (productCounts[item.productName]) {
                                        productCounts[item.productName] += item.count;
                                    } else {
                                        productCounts[item.productName] = item.count;
                                    }
                                });
                            }
                        }
                    });
                });

                let content = `
                    <div class="alert alert-info text-center">
                        <h4 class="mb-0">${totalOrders}</h4>
                        <small>تعداد فاکتورهای امروز</small>
                    </div>
                `;

                if (Object.keys(productCounts).length > 0) {
                    content += '<h6 class="fw-bold mt-4 mb-3 border-bottom pb-2">تفکیک کالاها (تعداد کارتن)</h6>';
                    content += '<ul class="list-group">';
                    for (const [name, count] of Object.entries(productCounts)) {
                        content += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${this.escapeHtml(name)}
                                <span class="badge bg-primary rounded-pill">${count}</span>
                            </li>
                        `;
                    }
                    content += '</ul>';
                } else {
                     content += '<p class="text-muted text-center mt-3">کالایی در سفارشات امروز ثبت نشده است.</p>';
                }

                document.getElementById('dailySalesContent').innerHTML = content;
                const modal = new bootstrap.Modal(document.getElementById('dailySalesModal'));
                modal.show();
            },

            // --- Helper: XSS Protection ---
            escapeHtml: function(text) {
                if (!text) return text;
                return text
                    .toString()
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            },

            // --- Rendering ---

            renderStores: function() {
                const container = document.getElementById('storesContainer');
                const emptyState = document.getElementById('emptyState');

                const dayFilter = document.getElementById('filterDay').value;
                const regionFilter = document.getElementById('filterRegion').value;
                const probFilter = document.getElementById('filterProb').value;
                const searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();

                let currentDayIndex = new Date().getDay(); // 0-6

                const filteredStores = this.data.stores.filter(store => {
                    // Search Filter
                    if (searchQuery) {
                        const searchMatch = store.name.toLowerCase().includes(searchQuery) ||
                                            (store.address && store.address.toLowerCase().includes(searchQuery));
                        if (!searchMatch) return false;
                    }

                    // Region Filter
                    if (regionFilter !== 'all' && store.region !== regionFilter) {
                        return false;
                    }

                    // Probability Filter
                    if (probFilter !== 'all' && store.purchaseProb !== probFilter) {
                        return false;
                    }

                    // Day Filter
                    if (dayFilter === 'all') {
                        return true;
                    } else if (dayFilter === 'today') {
                        // Check if today's index is in the store's visitDays array
                        // If visitDays is empty, maybe show it? No, strict filtering.
                        if (!store.visitDays || store.visitDays.length === 0) return false;
                        return store.visitDays.includes(currentDayIndex);
                    } else {
                        // Specific day selected
                        return store.visitDays.includes(parseInt(dayFilter));
                    }
                });

                // Sort by ID descending (Newest first)
                filteredStores.sort((a, b) => b.id - a.id);

                container.innerHTML = '';

                if (filteredStores.length === 0) {
                    emptyState.classList.remove('d-none');
                } else {
                    emptyState.classList.add('d-none');

                    filteredStores.forEach(store => {
                        // Generate Days Badges
                        let daysBadges = '';
                        store.visitDays.sort().forEach(d => {
                             // Simple highlighting if it matches today
                             const isToday = (d === currentDayIndex);
                             const badgeClass = isToday ? 'bg-primary' : 'bg-secondary';
                             daysBadges += `<span class="badge ${badgeClass} me-1">${this.daysMap[d]}</span>`;
                        });

                        // Ideal Time Badge
                        if (store.idealTime) {
                            daysBadges += `<span class="badge bg-info text-dark me-1"><i class="bi bi-clock"></i> ${this.idealTimeMap[store.idealTime]}</span>`;
                        }

                        // Purchase Probability Badge
                        if (store.purchaseProb) {
                            const probText = store.purchaseProb === 'high' ? 'احتمال خرید: زیاد' : 'احتمال خرید: کم';
                            const probClass = store.purchaseProb === 'high' ? 'bg-success' : 'bg-warning text-dark';
                            daysBadges += `<span class="badge ${probClass} me-1"><i class="bi bi-graph-up"></i> ${probText}</span>`;
                        }

                        // Generate Order History (Last 3)
                        let ordersHtml = '';
                        if (store.orders && store.orders.length > 0) {
                            ordersHtml = '<div class="order-history">';
                            ordersHtml += '<strong>۳ سفارش آخر:</strong><ul class="list-unstyled mb-0 mt-1">';
                            store.orders.slice(0, 3).forEach(o => {
                                let itemsText = '';
                                if (o.items && o.items.length > 0) {
                                    itemsText = o.items.map(i => `${i.count} ${this.escapeHtml(i.productName)}`).join('، ');
                                    itemsText = `<div class="text-primary smaller" style="font-size:0.75rem">${itemsText}</div>`;
                                }

                                ordersHtml += `<li class="d-flex flex-column mb-2 border-bottom pb-1">
                                    <div class="d-flex justify-content-between text-muted small">
                                        <span>${this.escapeHtml(o.date)}: ${this.escapeHtml(o.text)}</span>
                                        <div class="d-flex">
                                            <button class="btn btn-link btn-sm p-0 text-decoration-none me-2" onclick="app.editOrder(${store.id}, ${o.id})">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-link btn-sm p-0 text-decoration-none text-danger" onclick="app.deleteOrder(${store.id}, ${o.id})">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    ${itemsText}
                                </li>`;
                            });
                            ordersHtml += '</ul></div>';
                        }

                        const card = document.createElement('div');
                        card.className = 'col-md-6 col-lg-4';
                        card.innerHTML = `
                            <div class="card h-100 ${store.visited ? 'visited' : ''}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h5 class="card-title fw-bold mb-0">${this.escapeHtml(store.name)}</h5>
                                            <button class="btn btn-link btn-sm p-0 text-decoration-none" onclick="app.editStore(${store.id})" title="ویرایش">
                                                <i class="bi bi-pencil-square"></i> ویرایش
                                            </button>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox"
                                                ${store.visited ? 'checked' : ''}
                                                onchange="app.toggleVisit(${store.id})">
                                        </div>
                                    </div>
                                    <h6 class="card-subtitle mb-2 text-muted">
                                        <i class="bi bi-geo-alt-fill"></i> ${this.escapeHtml(store.region)}
                                    </h6>
                                    <p class="card-text small mb-2">${this.escapeHtml(store.address) || 'بدون آدرس'}</p>
                                    ${store.description ? `<p class="card-text small mb-2 text-muted">${this.escapeHtml(store.description)}</p>` : ''}
                                    ${store.sellerName ? `<p class="card-text small mb-2"><i class="bi bi-person"></i> ${this.escapeHtml(store.sellerName)}</p>` : ''}
                                    ${store.phone ? `<p class="card-text small mb-2"><i class="bi bi-telephone"></i> <a href="tel:${this.escapeHtml(store.phone)}" class="text-decoration-none">${this.escapeHtml(store.phone)}</a></p>` : ''}

                                    <div class="mb-3">
                                        ${daysBadges}
                                    </div>

                                    <button class="btn btn-sm btn-outline-primary w-100" onclick="app.openOrderModal(${store.id})">
                                        <i class="bi bi-cart-plus"></i> ثبت سفارش
                                    </button>

                                    ${ordersHtml}
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                }
            }
        };

        // Initialize App on Load
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>
